<?php
/**
 * @file
 */

/*
 * implement hook_init.
 */
function realty_init(){
  if(current_path() == '<front>') {
    if (!drupal_is_cli()) {
      drupal_goto('taxonomy/term/1');
    }
  }
}

/*
 * implement hook_menu.
 */
function realty_menu(){

  $item['get_developer_complex'] = array(
    'title' => 'complex',
    'page callback' => 'realty_get_developer_complex',
    'access callback' => TRUE,
  );

  $item['get_id_apartment'] = array(
    'title' => 'complex',
    'page callback' => 'realty_get_id_apartment',
    'access callback' => TRUE,
  );

  return $item;
}

/**
 * Implements hook_menu().
 */

function realty_theme() {

  $base = array(
    'file' => 'theme.inc',
    'path' => drupal_get_path('module', 'realty') . '/theme',
  );

  $items['search_form'] = array(
    'template' => 'search-form',
    'render element' => 'form',
  );

  $items['realty_user_menu'] = array(
    'template' => 'realty-user-menu',
    'variables' => array(
      'account' => NULL,
    ),
  );

  $items['realty_user_profile_form'] = $base + array(
    'template' => 'realty-user-profile-form',
    'render element' => 'form',
  );

  $items['id_apartment_pdf'] = array(
    'file' => 'theme.inc',
    'path' => drupal_get_path('module', 'realty') . '/theme',
    'variables' => array(
    ),
    'template' => 'realty-id-apartment-pdf',
  );

  return $items;
}

/**
 * List all cities.
 */
function realty_get_list_city(){
  $vid = taxonomy_vocabulary_machine_name_load('cities');
  return $terms = taxonomy_get_tree($vid->vid, 0, NULL, TRUE);
}

/**
 * Implement hook form_alter.
 */
function realty_form_user_profile_form_alter(&$form, &$form_id) {
  global $user;

  if($user->uid != 1) {
    $form['#theme'][0] = 'realty_user_profile_form';
  }
}

/**
 * Page callback to /get_id_apartment.
 */
function realty_get_id_apartment(){
  global $user;

  $account = user_load($user->uid);
  $node = node_load($_POST['nid']);
  $flag = FALSE;
  if (isset($account->field_received_id)) {
    if (!isset($account->field_received_id[LANGUAGE_NONE])) {
      $account->field_received_id = array(
        LANGUAGE_NONE => array(),
      );
    }
    foreach ($account->field_received_id[LANGUAGE_NONE] as $val) {
      if ($val['target_id'] == $node->nid) {
        $flag = TRUE;
        break;
      }
    }

    if ($flag == FALSE) {
      array_push($account->field_received_id[LANGUAGE_NONE], array('target_id' => $node->nid));
      user_save($account);
    }
    realty_generation_pdf_apartment($node);
    drupal_exit();
  }
}

/*
 *Page callback to /get_developer_complex.
 */
function realty_get_developer_complex() {

  foreach($_POST['developer'] as $value) {
    $developer_id[] = $value;
  }
  $complexs = realty_get_complex_current_city($developer_id, $_POST['city']);

  $select['li'][] = "<li class='ms-select-all'>
      <label>
          <input type='checkbox' name='selectAllcomplex'>[Выбрать все]
      </label>
    </li>";

  foreach($complexs as $key => $complex ) {
    $select['option'][] = "<option value=". $key .">". $complex ."</option>";
    $select['li'][] = "<li class='selected'>
        <label>
          <input type='checkbox' name='selectItemdeveloper' value=".$key.">
          ".$complex."
        </label>
      </li>";
  }

  print json_encode($select);
  drupal_exit();
}

/**
 * Get areas the current city
 */
function realty_get_areas_current_city() {

  $city = menu_get_object('taxonomy_term', 2);
  $city != null ? $city_tid = $city->tid : $city_tid = $_GET['city'];
  $view = views_get_view('search');
  $view->set_display('search_area');
  $view->display_handler->options['filters']['field_area_city_tid']['value'] = $city_tid;
  $view->pre_execute(array());
  $view->display_handler->preview();
  $view->post_execute();

  foreach($view->result as $value) {
    $area_option[$value->tid] = $value->taxonomy_term_data_name;
  }

  isset($area_option) ?  : $area_option = null;

  return $area_option;
}

/**
 * Get developers the current city
 */
function realty_get_developer_current_city(){
  $city = menu_get_object('taxonomy_term', 2);
  $city != null ? $city_tid = $city->tid : $city_tid = $_GET['city'];
  $view = views_get_view('term_view');
  $view->set_display('developers_search');
  $view->display_handler->options['arguments']['tid']['default_argument_options']['argument'] = $city_tid;
  $view->pre_execute(array());
  $view->display_handler->preview();
  $view->post_execute();
  foreach($view->result as $value) {
    $developer_option[$value->tid] = $value->_field_data['tid']['entity']->name;
  }

  isset($developer_option) ?  : $developer_option = null;

  return $developer_option;
}

/**
 * Get complex the current city
 */
function realty_get_complex_current_city($developers = null, $city_tid = null){
  $city = menu_get_object("taxonomy_term", 2);
  if(isset($_GET['city']) || $city) {
    $city != null ? $city_tid = $city->tid : $city_tid = $_GET['city'];
  }
  $view = views_get_view('complex');
  if($developers != null && $city == null) {
    $view->set_display('complex_developer');
    unset($view->display_handler->options['filters']['field_complex_developer_tid']['value']);
    foreach($developers as $value) {
      $view->display_handler->options['filters']['field_complex_developer_tid']['value'][$value] = $value;
    }
  }
  else {
    $view->set_display('complexs_search');
    $view->display_handler->options['arguments']['tid']['default_argument_options']['argument'] = $city_tid;
  }
  $view->pre_execute(array());
  $view->display_handler->preview();
  $view->post_execute();
  $complex_option = array();
  foreach($view->result as $value) {
    $complex_option[$value->nid] = $value->node_title;
  }

  isset($complex_option) ?  : $complex_option = null;

  return $complex_option;
}

/**
 * Generate pdf file id apartments.
 */
function realty_generation_pdf_apartment($node) {
  $html = theme('id_apartment_pdf', array());
  $error = FALSE;

  if (($library = libraries_load('phpwkhtmltopdf')) && !empty($library['loaded'])) {
    $pdf = new WkHtmlToPdf;
    $file_path = file_directory_temp() . '/' . time() . '.html';
    if (file_put_contents($file_path, $html)) {
      $pdf->addPage($file_path);
      $pdf_path = "/var/www/realty/sites/default/files/pdf/id_apartment-$node->nid.pdf";
      $pdf_file = "/sites/default/files/pdf/id_apartment-$node->nid.pdf";
      if (!$pdf->saveAS($pdf_path)) {
        $error = TRUE;
      }
      unlink($file_path);
    }
    else {
      $error = TRUE;
    }
  }
  else {
    $error = TRUE;
  }

  if ($error) {
    print $html;
  }

  print $pdf_file;

  drupal_exit();
}

/**
 * Form builder for search form.
 */
function realty_search_form($form, $form_state) {

  $area_option = realty_get_areas_current_city();
  $developer_option = realty_get_developer_current_city();
  $complex_option = realty_get_complex_current_city();
  $city = menu_get_object('taxonomy_term', 2);

  $room_option = array(
    '1'=>'1 комната',
    '2'=>'2 комнаты',
    '3'=>'3 комнаты',
    '4'=>'4 комнаты',
  );

  $quarter_option = array(
    '1' => '1 квартал',
    '2' => '2 квартал',
    '3' =>'3 квартал',
    '4' =>'4 квартал',
  );

  $masonry_option = array(
    '1' => 'Кирпич',
  );

  $form['city'] = array(
    '#type' => 'hidden',
    '#title' => 'city',
    '#value' => isset($_GET['city']) ? $_GET['city'] : $city->tid,
  );

  $form['area'] = array(
    '#type'=>'select',
    '#title'=>'Area',
    '#name'=>'area[]',
    '#options'=> $area_option,
    '#default_value' => isset($_GET['area']) ? $_GET['area'] : 0,
    '#attributes' => array(
      'id' => 'area',
      'multiple' => 'multiple',
    ),
  );

  $form['masonry'] = array(
    '#type'=>'select',
    '#title'=>'Masonry',
    '#name'=>'masonry[]',
    '#options'=> $masonry_option,
    '#default_value' => isset($_GET['masonry']) ? $_GET['masonry'] : 0,
    '#attributes' => array(
      'id' => 'masonry',
      'multiple' => 'multiple',
    ),
  );

  $form['floor'] = array(
    '#type'=>'textfield',
    '#title'=>'floor',
    '#default_value' => isset($_GET['floor']) ? $_GET['floor'] : 0,
    '#attributes'=>array(
      'size' => 2,
      'maxlength' => 2,
    ),
  );

  $form['room'] = array(
    '#type'=>'select',
    '#title'=>'Number of room',
    '#name'=>'room[]',
    '#options'=> $room_option,
    '#default_value' => isset($_GET['room']) ? $_GET['room'] : 0,
    '#attributes'=>array(
      'id' => 'room',
      'multiple' => 'multiple',
    ),
  );

  $form['sq_from'] = array(
    '#type'=>'textfield',
    '#title'=>'Sq from',
    '#default_value' => isset($_GET['sq_from']) ? $_GET['sq_from'] : 0,
    '#attributes'=>array(
      'size' => 4,
      'maxlength' => 5,
    ),
  );

  $form['sq_to'] = array(
    '#type'=>'textfield',
    '#title'=>'Sq to',
    '#default_value' => isset($_GET['sq_to']) ? $_GET['sq_to'] : 0,
    '#attributes'=>array(
      'size' => 4,
      'maxlength' => 5,
    ),
  );

  $form['price_from'] = array(
    '#type'=>'textfield',
    '#title'=>'Price from',
    '#default_value' => isset($_GET['price_from']) ? $_GET['price_from'] : 0,
    '#attributes'=>array(
      'size' => 4,
      'maxlength' => 10,
    ),
  );

  $form['price_to'] = array(
    '#type'=>'textfield',
    '#title'=>'Price to',
    '#default_value' => isset($_GET['price_to']) ? $_GET['price_to'] : 0,
    '#attributes'=>array(
      'size' => 4,
      'maxlength' => 10,
    ),
  );

  $form['parking'] = array(
    '#type'=>'checkbox',
    '#title'=>'Parking',
    '#default_value' => isset($_GET['parking']) ? $_GET['parking'] : 0,
  );

  $form['coast_from'] = array(
    '#type'=>'textfield',
    '#title'=>'Coast from',
    '#default_value' => isset($_GET['coast_from']) ? $_GET['coast_from'] : 0,
    '#attributes'=>array(
      'size' => 7,
      'maxlength' => 10,
    ),
  );

  $form['coast_to'] = array(
    '#type'=>'textfield',
    '#title'=>'Coast to',
    '#default_value' => isset($_GET['coast_to']) ? $_GET['coast_to'] : 0,
    '#attributes'=>array(
      'size' => 7,
      'maxlength' => 10,
    ),
  );

  $form['developer'] = array(
    '#type'=>'select',
    '#title'=>'Developer',
    '#name'=>'developer[]',
    '#options'=> $developer_option,
    '#default_value' =>isset($_GET['developer']) ? $_GET['developer'] : 0,
    '#attributes' => array(
      'id' => 'developer',
      'multiple' => 'multiple',
    ),
  );

  $form['complex'] = array(
    '#type'=>'select',
    '#title'=>'Complex',
    '#options'=> $complex_option,
    '#attributes' => array(
      'id' => 'complex',
      'multiple' => 'multiple',
    ),
  );

  $form['quarter'] = array(
    '#type'=>'select',
    '#title'=>'Quarter',
    '#name'=>'quarter[]',
    '#options'=> $quarter_option,
    '#default_value' =>isset($_GET['quarter']) ? $_GET['quarter'] : 0,
    '#attributes' => array(
      'id' => 'quarter',
      'multiple' => 'multiple',
    ),
  );

  $form['year'] = array(
    '#type'=>'textfield',
    '#title'=>'Year',
    '#default_value' =>isset($_GET['year']) ? $_GET['year'] : 0,
    '#attributes'=>array(
      'size' => 7,
      'maxlength' => 10,
    ),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Search'),
  );

  $form['#method'][] = 'GET';
  $form['#action'] = '/search';
  $form['#theme'][] = 'search_form';

  return $form;
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function realty_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'panels') {
    return "plugins/$plugin_type";
  }

  if ($owner == 'ctools' && $plugin_type == 'content_types') {
    return "plugins/content_types";
  }
}

/**
 * Draw user menu.
 */
function realty_user_menu($account) {

  return theme('realty_user_menu', array('account' => $account));
}

/**
 * Get the current city.
 */
function realty_get_current_city() {

  if (!isset($_GET['q'])) {
    return null;
  }

  $entity = explode('/' ,$_GET['q']);

  if ($entity[0] == 'taxonomy') {
    $term = taxonomy_term_load($entity[2]);
    if ($term->vocabulary_machine_name == 'cities') {
      return $term->name;
    }
    if ($term->vocabulary_machine_name == 'developers' ) {
      $city_id = $term->field_city[LANGUAGE_NONE][0]['tid'];
      $city = taxonomy_term_load($city_id);
      return $city->name;
    }
  }
  if ($entity[0] == 'node') {
    $node = node_load($entity[1]);
    if ($node->type == 'complex') {
      $dev_id = $node->field_complex_developer[LANGUAGE_NONE][0]['tid'];
      $term = taxonomy_term_load($dev_id);
      $city_id = $term->field_city[LANGUAGE_NONE][0]['tid'];
      $city = taxonomy_term_load($city_id);
      return $city->name;
    }
    if ($node->type == 'apartament') {
      $home_id = $node->field_apartament_home[LANGUAGE_NONE][0]['tid'];
      $home = taxonomy_term_load($home_id);
      $complex_id = $home->field_home_complex[LANGUAGE_NONE][0]['target_id'];
      $complex = node_load($complex_id);
      $dev_id = $complex->field_complex_developer[LANGUAGE_NONE][0]['tid'];
      $term = taxonomy_term_load($dev_id);
      $city_id = $term->field_city[LANGUAGE_NONE][0]['tid'];
      $city = taxonomy_term_load($city_id);
      return $city->name;
    }
  }
}