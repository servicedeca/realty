<?php
/**
 * @file
 */

define('REALTY_FRONT_THEME_PATH', drupal_get_path('theme', 'realty_theme'));

/*
 * implement hook_init.
 */
function realty_init() {
  drupal_add_js(array('REALTY_FRONT_THEME_PATH' => REALTY_FRONT_THEME_PATH), 'setting');
  $object = menu_get_object('taxonomy_term', 2);

  if (current_path() == '<front>') {
    if (!drupal_is_cli()) {
      drupal_goto('taxonomy/term/1');
    }
  }

  if (!empty($object) && $object->vid == 1) {
    drupal_add_js(array(
      'id' => 'index',
      'city' => $object->tid,), 'setting');
  }
}

/*
 * Implement hook_taxonomy_term_insert.
 */
function realty_taxonomy_term_insert($term) {
  if ($term->vid == '6' ) {
      $place = json_decode($term->field_map['und'][0]['placemarks']);
      $place[0]->params->tid = $term->tid;
      $term->field_map['und'][0]['placemarks'] = json_encode($place);
      taxonomy_term_save($term);
  }
}

/*
 * Implement hook_taxonomy_term_presave.
 */
function realty_taxonomy_term_presave($term) {
  if ($term->tid) {
    $place = json_decode($term->field_map['und'][0]['placemarks']);
    $place[0]->params->tid = $term->tid;
    $term->field_map['und'][0]['placemarks'] = json_encode($place);
  }
}

/**
 * get the path to the directory /files
 */

function realty_file_directory_path() {
  return variable_get('file_directory_path', conf_path() .'/files');
}

/*
 * implement hook_menu.
 */
function realty_menu() {

  $item['get_developer_complex'] = array(
    'title' => 'complex',
    'page callback' => 'realty_get_developer_complex',
    'access callback' => TRUE,
  );

  $item['get_id_apartment'] = array(
    'page callback' => 'realty_get_id_apartment',
    'access callback' => TRUE,
  );

  $item['apartment_comparison'] = array(
    'page callback' => 'realty_apartment_comparison',
    'access callback' => TRUE,
  );

  $item['search_map'] = array(
    'page callback' => 'realty_search_map',
    'access callback' => TRUE,
  );

  $item['get_data_complex'] = array(
    'page callback' => 'realty_get_data_complex',
    'access callback' => TRUE,
  );

  $item['apartment_signal'] = array(
    'page callback' => 'realty_apartment_signal',
    'access callback' => TRUE,
  );

  $item['realty_add_comment'] = array(
    'page callback' => 'realty_add_comment',
    'access callback' => TRUE,
  );

  return $item;
}

/**
 * Implements hook_menu().
 */

function realty_theme() {

  $base = array(
    'file' => 'theme.inc',
    'path' => drupal_get_path('module', 'realty') . '/theme',
  );

  $items['search_form'] = array(
    'template' => 'search-form',
    'render element' => 'form',
  );

  $items['realty_user_menu'] = array(
    'template' => 'realty-user-menu',
    'variables' => array(
      'account' => NULL,
    ),
  );

  $items['realty_user_profile_form'] = $base + array(
    'template' => 'realty-user-profile-form',
    'render element' => 'form',
  );

  $items['realty_modal_search_form'] = array(
    'template' => 'realty-modal-search-form',
  );

  $items['id_apartment_pdf'] = array(
    'file' => 'theme.inc',
    'path' => drupal_get_path('module', 'realty') . '/theme',
    'variables' => array(
    ),
    'template' => 'realty-id-apartment-pdf',
  );

  $items['sending_messages'] = $base + array(
    'template' => 'realty-sending-messages',
    'variables' => array('node' => NULL),
  );

  $items['realty_comment_form'] = array(
    'render element' => 'form',
    'template' => 'realty-comment-form',
  );

  $items['realty_views_exposed_form'] = $base + array(
    'render_element' => 'form',
    'template' => 'realty-views-exposed-form',
  );


  return $items;

}

/**
 * Page callback to /realty_add_comment.
 */
function realty_add_comment() {
  global $user;

  if ($_POST['comment'] && $_POST['nid']) {
    $comment = new stdClass();
    $comment->nid = $_POST['nid'];
    $comment->uid = $user->uid;
    $comment->name = $user->name;
    $comment->subject = 'Subject';
    $comment->field_body[LANGUAGE_NONE][0]['value'] = $_POST['comment'];
    $comment->field_body[LANGUAGE_NONE][0]['format'] = null;
    $comment->field_body[LANGUAGE_NONE][0]['safe_value'] = $_POST['comment'];
    $comment->hostname = $_SERVER['REMOTE_HOST'] ? $_SERVER['REMOTE_HOST'] : '127.0.0.1';
    $comment->thread = '01/';
    $comment = comment_submit($comment);
    comment_save($comment);
    print TRUE;
    drupal_exit();
  }
  else {
    print FALSE;
    drupal_exit();
  }
}

/**
 * Page callback to /get_data_complex.
 */
function realty_get_data_complex() {

  if ($_POST['nid']) {
    $node = node_load($_POST['nid']);

    $answer['title'] = $node->title;

    $answer['image'] = theme('image', array(
      'path' => $node->field_main_photo['und'][0]['uri'],
      'attributes' => array(
        'class' => array('title-image'),
      ),
    ));

    if (!empty($node->field_complex_logo)) {
      $answer['logo'] = theme('image', array(
        'path' => $node->field_complex_logo['und'][0]['uri'],
        'attributes' => array(
          'class' => array('logo-z', 'vertical-logo'),
        ),
      ));
    }

    if(!empty($node->field_description)) {
      $answer['description'] = $node->field_description['und'][0]['value'];
    }

    $answer['details'] = l('details', 'node/' . $node->nid, array('attributes' => array('class' => array(
      'button-info','button-info-top')
    )));

    print json_encode($answer);
  }

  drupal_exit();
}

/**
 * List all cities.
 */
function realty_get_list_city(){
  $vid = taxonomy_vocabulary_machine_name_load('cities');
  return $terms = taxonomy_get_tree($vid->vid, 0, NULL, TRUE);
}

/**
 * Page callback to /search_map.
 */
function realty_search_map() {

  $areas = $_POST['area'];
  $developers = $_POST['developer'];
  $complexes = $_POST['complex'];
  $categorys = $_POST['category'];
  $stock = $_POST['stock'];

  $view = views_get_view('map');
  $view->set_display('map_city');
  if (!empty($stock)) {
    $view->display_handler->options['filters']['field_stock_value']['value'] = $stock;
  }
  if (!empty($categorys)) {
    foreach ($categorys as $category) {
      $view->display_handler->options['filters']['field_category_value']['value'][] = $category;
    }
  }
  if (!empty($areas)) {
    foreach ($areas as $area) {
      $view->display_handler->options['filters']['field_area_tid']['value'][] = $area;
    }
  }
  if (!empty($developers)) {
    foreach ($developers as $developer) {
      $view->display_handler->options['filters']['field_complex_developer_tid']['value'][] = $developer;
    }
  }
  if (!empty($complexes)) {
    foreach ($complexes as $complex) {
      $view->display_handler->options['filters']['field_home_complex_target_id']['value'][] = $complex;
    }
  }
  $view->pre_execute(array());
  $view->display_handler->preview();
  $view->post_execute();
  if (!empty($view->result)) {
    foreach($view->result as $key => $tid) {
      $homes[$key]['tid'] = $tid->tid;
      $homes[$key]['address'] = $tid->_field_data['tid']['entity']->field_address_house['und'][0]['value'];
    }
    print json_encode($homes);
  }
  else
    print FALSE;
 }

/**
 * Page callback to /apartment_signal.
 */
function realty_apartment_signal() {
  global $user;

  if($user->uid != 0) {
    if($_POST['nid']) {
      if (realty_check_status_apartment_user($user->uid, $_POST['nid']) == TRUE) {
        print TRUE;
        drupal_exit();
      }
      else {
        $node = node_load($_POST['nid']);
        $node->field_user_signal[LANGUAGE_NONE][]['target_id'] = $user->uid;
        field_attach_update('node', $node);
        node_save($node);
        if ($_POST['apartment'] == 0) {
          $dindo = theme('image', array(
            'path' => REALTY_FRONT_THEME_PATH . '/images/dingdongr.svg',
            'attributes' => array(
              'class' => array('dingdong'),
            ),
          ));

          $dindon_r = l($dindo , '#href', array(
            'html' => TRUE,
            'external' => TRUE,
            'attributes' => array(
              'rel' => 'tooltip',
              'data-placement' => 'right',
              'title' => 'Notification will be sent to the withdrawal of reservations',
            ),
          ));
        }
        else {
          $dindo = theme('image', array(
            'path' => REALTY_FRONT_THEME_PATH . '/images/dingdong_big.svg',
            'attributes' => array(
              'class' => array('bad-button-fix'),
            ),
          ));

          $dindon_r = l($dindo . '<span class="new-tip-button">
          '. t('Send notification if your removed') .'
          </span>' , '#href', array(
            'html' => TRUE,
            'external' => TRUE,
            'attributes' => array(
              'rel' => 'tooltip',
              'data-placement' => 'right',
            ),
          ));
        }
        print $dindon_r;
        drupal_exit();
      }
    }
  }
  else {
    print 'user';
    drupal_exit();
  }
}

/**
 * Sending messages to users about the withdrawal of the reservation.
 */
function realty_sending_messages_to_users ($node) {
  $module = 'realty';
  $key = 'key';
  $language = 'ru';
  $params = array();
  $from = variable_get('site_mail');
  $send = FALSE;
  foreach ($node->field_user_signal[LANGUAGE_NONE] as $uid) {
    $user = user_load($uid['target_id']);
    $message = drupal_mail($module, $key, $user->mail, $language, $params, $from, $send);
    $message['subject'] = 'Уведомление о снятии бронирования!';
    $message['body'] = array();
    $message['body'][] = theme('sending_messages', array('node' => $node));
    $system = drupal_mail_system($module, $key);
    $message = $system->format($message);
    $message['result'] = $system->mail($message);
  }
  return $message['result'];
}



/**
 * Implement hook_node_presave.
 */
function realty_node_presave($node) {
  if ($node->type == 'stock') {
    if (!empty($node->field_complex_stock)) {
      $complex = node_load($node->field_complex_stock['und'][0]['target_id']);
      $complex->field_stock['und'][0]['value'] = 1;
      field_attach_update('node', $complex);
    }
  }

 /* if ($node->type == 'apartament') {
    if ($node->field_status['und'][0]['value'] == 0) {
      $node->field_hiden_status[LANGUAGE_NONE][0]['value'] = 0;
      field_attach_update('node', $node);
      node_save($node);
      drupal_exit();
    }
    if ($node->field_hiden_status[LANGUAGE_NONE][0]['value'] == 0 && $node->field_status[LANGUAGE_NONE][0]['value'] == 1) {
      $node->field_hiden_status[LANGUAGE_NONE][0]['value'] = 1;
      if (realty_sending_messages_to_users($node) == TRUE) {
        unset($node->field_user_signal['und']);
        field_attach_update('node', $node);
        node_save($node);
        drupal_exit();
      }
      else {
        field_attach_update('node', $node);
        node_save($node);
        drupal_exit();
      }
    }
  }*/
}

/**
 * Implement hook form_alter.
 */
function realty_form_user_profile_form_alter(&$form, &$form_id) {
  global $user;

  if($user->uid != 1) {
    $form['#theme'][0] = 'realty_user_profile_form';
  }
}

/**
 * Page callback to /get_id_apartment.
 */
function realty_get_id_apartment() {
  global $user;

  $account = user_load($user->uid);
  $node = node_load($_POST['nid']);
  $flag = FALSE;
  if (isset($account->field_received_id)) {
    if (!isset($account->field_received_id[LANGUAGE_NONE])) {
      $account->field_received_id = array(
        LANGUAGE_NONE => array(),
      );
    }
    foreach ($account->field_received_id[LANGUAGE_NONE] as $val) {
      if ($val['target_id'] == $node->nid) {
        $flag = TRUE;
        break;
      }
    }

    if ($flag == FALSE) {
      array_push($account->field_received_id[LANGUAGE_NONE], array('target_id' => $node->nid));
      user_save($account);
    }
    realty_generation_pdf_apartment($node);
    drupal_exit();
  }
}

/**
 * Page callback to /get_id_apartment.
 */
function realty_apartment_comparison() {
  global $user;

  $account = user_load($user->uid);
  if ($user->uid != 0 ) {
    $node = node_load($_POST['nid']);
    $flag = FALSE;
    if (isset($account->field_apartment_comparison)) {
      if (!isset($account->field_apartment_comparison[LANGUAGE_NONE])) {
        $account->field_apartment_comparison = array(
          LANGUAGE_NONE => array(),
        );
      }
      foreach ($account->field_apartment_comparison[LANGUAGE_NONE] as $val) {
        if ($val['target_id'] == $node->nid) {
          $flag = TRUE;
          break;
        }
      }

      if ($flag == FALSE) {
        array_push($account->field_apartment_comparison[LANGUAGE_NONE], array('target_id' => $node->nid));
        user_save($account);

        $_POST['apartment'] == 0 ? $path = REALTY_FRONT_THEME_PATH . '/images/ready.svg' :
          $path = REALTY_FRONT_THEME_PATH . '/images/ready_comprasion.svg';

        if ($_POST['apartment'] == 0) {
          $add = theme('image', array (
            'path' => REALTY_FRONT_THEME_PATH . '/images/ready.svg',
            'attributes' => array(
              'class' => array('add'),
            ),
          ));

          $add_r = l($add , '#href', array(
            'html' => TRUE,
            'external' => TRUE,
            'attributes' => array(
              'title' => t('Apartment in comparison'),
              'data-placement' => 'right',
              'rel' => 'tooltip',
              'class' => array('added-comparison'),
            ),
          ));
        }
        else {
          $add = theme('image', array (
            'path' => REALTY_FRONT_THEME_PATH . '/images/ready_comprasion.svg',
            'attributes' => array(
              'class' => array(''),
            ),
          ));

          $add_r = l($add.'<div class="tip-button" id="comparison">
        '.t('added to comparison').'
        </div>' , '#href', array(
            'html' => TRUE,
            'external' => TRUE,
            'attributes' => array(
              'class' => array('added-comparison'),
            ),
          ));
        }

         print $add_r;
      }

      else {
        print TRUE;
      }
      drupal_exit();
    }
  }
}

/*
 *Page callback to /get_developer_complex.
 */
function realty_get_developer_complex() {
  if (isset($_POST['developer'])) {
    foreach($_POST['developer'] as $value) {
      $developer_id[] = $value;
    }
    $complexes = realty_get_complex_current_city($developer_id, $_POST['city']);
  }
  else {
    $complexes = realty_get_complex_current_city(null, $_POST['city']);
  }
  $options = '';
  if (!empty($complexes)) {
    foreach($complexes as $key => $complex) {
      if($_POST['map']) {
        $options['modal'] .= '<div class="col-xs-4">
          <li>
            <label class="checkbox-inline check-style">
              <input type="checkbox" class="inlineCheckbox1 CheckboxMapComplex" value="'.$key.'">'.$complex.'
            </label>
        </li>
      </div>';
        $options['select'] .= '<option value='.$key.'>'.$complex.'</option>';
      }
      else {
        $options['modal'] .= '<div class="col-xs-4">
            <li>
              <label class="checkbox-inline check-style">
                <input type="checkbox" class="inlineCheckbox1 CheckboxComplex complex-' . $key . '" value="' . $key. ';' . $complex .'"> ' . $complex . '
              </label>
          </li>
        </div>';
        $options['select'] .= '<option value='.$key.'>'.$complex.'</option>';
      }
    }
  }
  print json_encode($options);
  drupal_exit();
}


/**
 * Get options the current city
 */
function realty_get_options_current_city($option) {

  $city = menu_get_object('taxonomy_term', 2);
  $city != null ? $city_tid = $city->tid : $city_tid = $_GET['city'];
  $view = views_get_view('search');
  if ($option == 'area') {
    $view->set_display('search_area');
    $view->display_handler->options['filters']['field_area_city_tid']['value'] = $city_tid;
  }
  if ($option == 'metro') {
    $view->set_display('search_metro');
    $view->display_handler->options['filters']['field_city_metro_tid']['value'] = $city_tid;
  }
  $view->pre_execute(array());
  $view->display_handler->preview();
  $view->post_execute();

  foreach($view->result as $value) {
    $options[$value->tid] = $value->taxonomy_term_data_name;
  }

  isset($options) ?  : $options = null;

  return $options;
}


/**
 * Get developers the current city
 */
function realty_get_developer_current_city() {
  $city = menu_get_object('taxonomy_term', 2);
  $city != null ? $city_tid = $city->tid : $city_tid = $_GET['city'];
  $view = views_get_view('term_view');
  $view->set_display('developers_search');
  $view->display_handler->options['arguments']['tid']['default_argument_options']['argument'] = $city_tid;
  $view->pre_execute(array());
  $view->display_handler->preview();
  $view->post_execute();
  foreach($view->result as $value) {
    $developer_option[$value->tid] = $value->_field_data['tid']['entity']->name;
  }

  isset($developer_option) ?  : $developer_option = null;

  return $developer_option;
}

/**
 * Get complex the current city
 */
function realty_get_complex_current_city($developers = null, $city_tid = null) {
  $city = menu_get_object("taxonomy_term", 2);
  if(isset($_GET['city']) || $city) {
    $city != null ? $city_tid = $city->tid : $city_tid = $_GET['city'];
  }
  $view = views_get_view('complex');
  if($developers != null && $city == null) {
    $view->set_display('complex_developer');
    unset($view->display_handler->options['filters']['field_complex_developer_tid']['value']);
    foreach($developers as $value) {
      $view->display_handler->options['filters']['field_complex_developer_tid']['value'][$value] = $value;
    }
  }
  else {
    $view->set_display('complexs_search');
    $view->display_handler->options['arguments']['tid']['default_argument_options']['argument'] = $city_tid;
  }
  $view->pre_execute(array());
  $view->display_handler->preview();
  $view->post_execute();
  $complex_option = array();
  foreach($view->result as $value) {
    $complex_option[$value->nid] = $value->node_title;
  }

  isset($complex_option) ?  : $complex_option = null;

  return $complex_option;
}

/**
 * Generate pdf file id apartments.
 */
function realty_generation_pdf_apartment($node) {
  $html = theme('id_apartment_pdf', array());
  $error = FALSE;

  if (($library = libraries_load('phpwkhtmltopdf')) && !empty($library['loaded'])) {
    $pdf = new WkHtmlToPdf;
    $file_path = file_directory_temp() . '/' . time() . '.html';
    if (file_put_contents($file_path, $html)) {
      $pdf->addPage($file_path);
      $pdf_path = "/var/www/realty/sites/default/files/pdf/id_apartment-$node->nid.pdf";
      $pdf_file = "/sites/default/files/pdf/id_apartment-$node->nid.pdf";
      if (!$pdf->saveAS($pdf_path)) {
        $error = TRUE;
      }
      unlink($file_path);
    }
    else {
      $error = TRUE;
    }
  }
  else {
    $error = TRUE;
  }

  if ($error) {
    print $html;
  }

  print $pdf_file;

  drupal_exit();
}

/**
 * Form builder for search map form.
 */
function realty_realty_comment_form($form, $form_state) {

  $form['body'] = array(
    '#title'=>'body',
    '#type' => 'textfield',
    '#rows' => 6,
    'attributes' => array(
      'class' => array('form-control', 'comment-textarea'),
    ),
  );

  $form['#theme'][] = 'realty_comment_form';

  return $form;
}


/**
 * Form builder for search map form.
 */
function realty_search_map_form($form, $form_state) {

  $category_option = realty_options_search('category');

  $form['category'] = array(
    '#type'=>'select',
    '#title'=>'Category',
    '#name'=>'category[]',
    '#options'=> $category_option,
    '#attributes' => array(
      'id' => 'map-filter',
      'multiple' => 'multiple',
      'class' => array('maps'),
    ),
  );

  return $form;
}

/**
 * Options to search for apartments.
 */

function realty_options_search($option) {

  switch ($option) {
    case 'room' :
      return array(
      '1'=>'1 комната',
      '2'=>'2 комнаты',
      '3'=>'3 комнаты',
      '4'=>'4 комнаты',
      );

    case 'quarter' :
      return array(
      '1' => '1 квартал',
      '2' => '2 квартал',
      '3' =>'3 квартал',
      '4' =>'4 квартал',
      );

    case 'masonry' :
      return array(
      '1' => 'Кирпич',
      '2' => 'Монолит',
      );

    case 'category' :
      return array(
      '1' => 'Эконом',
      '2' => 'Комфорт',
      '3' => 'Бизнес',
      );
    case 'balcony' :
      return array(
        '1' => 'Балкон',
        '2' => 'Лоджия',
      );
  }
}

/**
 * Form builder for search form.
 */
function realty_search_form($form, $form_state) {

  $area_option = realty_get_options_current_city('area');
  $metro_option = realty_get_options_current_city('metro');
  $developer_option = realty_get_developer_current_city();
  $complex_option = realty_get_complex_current_city();
  $room_option = realty_options_search('room');
  $quarter_option = realty_options_search('quarter');
  $masonry_option = realty_options_search('masonry');
  $balcony_option = realty_options_search('balcony');
  $category_option = realty_options_search('category');
  $city = menu_get_object('taxonomy_term', 2);

  $form['city'] = array(
    '#type' => 'hidden',
    '#title' => 'city',
    '#value' => isset($_GET['city']) ? $_GET['city'] : $city->tid,
  );

  $form['area'] = array(
    '#type'=>'select',
    '#title'=>'Area',
    '#name'=>'area[]',
    '#options'=> $area_option,
    '#default_value' => isset($_GET['area']) ? $_GET['area'] : 0,
    '#attributes' => array(
      'id' => 'area',
      'multiple' => 'multiple',
    ),
  );

  $form['metro'] = array(
    '#type'=>'select',
    '#title'=>'metro',
    '#name'=>'metro[]',
    '#options'=> $metro_option,
    '#default_value' => isset($_GET['metro']) ? $_GET['metro'] : 0,
    '#attributes' => array(
      'id' => 'metro',
      'multiple' => 'multiple',
    ),
  );

  $form['masonry'] = array(
    '#type'=>'select',
    '#title'=>'Masonry',
    '#name'=>'masonry[]',
    '#options'=> $masonry_option,
    '#default_value' => isset($_GET['masonry']) ? $_GET['masonry'] : 0,
    '#attributes' => array(
      'id' => 'wall_type',
      'multiple' => 'multiple',
      'class' => array('ss'),
    ),
  );


  $form['balcony'] = array(
    '#type'=>'select',
    '#title'=>'balcony',
    '#name'=>'balcony[]',
    '#options'=> $balcony_option,
    '#default_value' => isset($_GET['balcony']) ? $_GET['balcony'] : false,
    '#attributes' => array(
      'id' => 'balkon',
      'multiple' => 'multiple',
      'class' => array('ss'),
    ),
  );

  $form['category'] = array(
    '#type'=>'select',
    '#title'=>'Category',
    '#name'=>'category[]',
    '#options'=> $category_option,
    '#default_value' => isset($_GET['category']) ? $_GET['category'] : 0,
    '#attributes' => array(
      'id' => 'cat',
      'multiple' => 'multiple',
      'class' => array('ss mini-ss'),
    ),
  );

  $form['floor'] = array(
    '#type'=>'textfield',
    '#title'=>'floor',
    '#default_value' => isset($_GET['floor']) ? $_GET['floor'] : false,
    '#attributes'=>array(
      'id' => 'floor',
      'maxlength' => 2,
      'class' => array('search-input',
        'mini-width',
        'floor',
      ),
    ),
  );

  $form['room'] = array(
    '#type'=>'select',
    '#title'=>'Number of room',
    '#name'=>'room[]',
    '#options'=> $room_option,
    '#default_value' => isset($_GET['room']) ? $_GET['room'] : 0,
    '#attributes'=>array(
      'id' => 'room',
      'multiple' => 'multiple',
    ),
  );

  $form['sq'] = array(
    '#type'=>'hidden',
    '#title'=>'Sq from',
    '#default_value' => isset($_GET['sq']) ? $_GET['sq'] : '30;150',
    '#attributes'=>array(
      'class' => array('ion-slider', 'sq'),
    ),
  );

  $form['price'] = array(
    '#type'=>'hidden',
    '#title'=>'Price from',
    '#default_value' => isset($_GET['price']) ? $_GET['price'] : '55;85',
    '#attributes'=>array(
      'class' => array('ion-slider', 'price'),
    ),
  );

  $form['parking'] = array(
    '#type'=>'checkbox',
    '#title'=>'Parking',
    '#default_value' => isset($_GET['parking']) && $_GET['parking'] == 1  ? 1 : 0,
    '#attributes'=>array(
      'id ' => 'parking',
    ),
  );

  $form['coast'] = array(
    '#type'=>'hidden',
    '#title'=>'Coast',
    '#default_value' => isset($_GET['coast']) ? $_GET['coast'] : '1.6;4',
    '#attributes'=>array(
      'class' => array('ion-slider', 'coast'),
    ),
  );

  $form['developer'] = array(
    '#type'=>'select',
    '#title'=>'Developer',
    '#name'=>'developer[]',
    '#options'=> $developer_option,
    '#default_value' =>isset($_GET['developer']) ? $_GET['developer'] : 0,
    '#attributes' => array(
      'id' => 'developer',
      'multiple' => 'multiple',
    ),
  );

  $form['complex'] = array(
    '#type'=>'select',
    '#title'=>'Complex',
    '#name'=>'complex[]',
    '#options'=> $complex_option,
    '#default_value' =>isset($_GET['complex']) ? $_GET['complex'] : 0,
    '#attributes' => array(
      'id' => 'complex',
      'multiple' => 'multiple',
    ),
  );

  $form['quarter'] = array(
    '#type'=>'select',
    '#title'=>'Quarter',
    '#name'=>'quarter[]',
    '#options'=> $quarter_option,
    '#default_value' =>isset($_GET['quarter']) ? $_GET['quarter'] : 0,
    '#attributes' => array(
      'id' => 'date',
      'multiple' => 'multiple',
      'class' => array('ss mini-ss'),
    ),
  );

  $form['year'] = array(
    '#type'=>'textfield',
    '#title'=>'Year',
    '#default_value' =>isset($_GET['year']) ? $_GET['year'] : null,
    '#attributes'=>array(
      'class' => array('search-input ear'),
      'placeholder' => t('Year'),
      'maxlength' => '4',
    ),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Choose option'),
    '#attributes' => array(
      'class' => array('search-button'),
    ),
  );

  $form['#method'][] = 'GET';
  $form['#action'] = '/search';
  $form['#theme'][] = 'search_form';

  return $form;
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function realty_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'panels') {
    return "plugins/$plugin_type";
  }

  if ($owner == 'ctools' && $plugin_type == 'content_types') {
    return "plugins/content_types";
  }
}

/**
 * Checking apartments in comparison.
 */
function realty_checking_apartments_comparison($nid) {
  global $user;
  $account = user_load($user->uid);

  $flag = FALSE;
  if (!empty($account->field_apartment_comparison)) {
    foreach ($account->field_apartment_comparison[LANGUAGE_NONE] as $apartment) {
      if ($apartment['target_id'] == $nid) {
        $flag = TRUE;
        break;
      }
    }
  }

  return $flag;
}

/**
 * Check subscription status tracking
 */
function realty_check_status_apartment_user($uid, $nid) {
  $node = node_load($nid);
  $flag = FALSE;
  foreach ($node->field_user_signal['und'] as $value) {
    if ($value['target_id'] == $uid) {
      $flag = TRUE;
      break;
    }
  }
  return $flag;
}

/**
 * Draw user menu.
 */
function realty_user_menu($account) {

  return theme('realty_user_menu', array('account' => $account));
}

/**
 * Get the current city.
 */
function realty_get_current_city() {

  if (!isset($_GET['q'])) {
    return null;
  }

  $entity = explode('/' ,$_GET['q']);

  if ($entity[0] == 'taxonomy') {
    $term = taxonomy_term_load($entity[2]);
    if ($term->vocabulary_machine_name == 'cities') {
      return $term->name;
    }
    if ($term->vocabulary_machine_name == 'developers' ) {
      $city_id = $term->field_city[LANGUAGE_NONE][0]['tid'];
      $city = taxonomy_term_load($city_id);
      return $city->name;
    }
  }
  if ($entity[0] == 'node') {
    $node = node_load($entity[1]);
    if ($node->type == 'complex') {
      $dev_id = $node->field_complex_developer[LANGUAGE_NONE][0]['tid'];
      $term = taxonomy_term_load($dev_id);
      $city_id = $term->field_city[LANGUAGE_NONE][0]['tid'];
      $city = taxonomy_term_load($city_id);
      return $city->name;
    }
    if ($node->type == 'apartament') {
      $home_id = $node->field_apartament_home[LANGUAGE_NONE][0]['tid'];
      $home = taxonomy_term_load($home_id);
      $complex_id = $home->field_home_complex[LANGUAGE_NONE][0]['target_id'];
      $complex = node_load($complex_id);
      $dev_id = $complex->field_complex_developer[LANGUAGE_NONE][0]['tid'];
      $term = taxonomy_term_load($dev_id);
      $city_id = $term->field_city[LANGUAGE_NONE][0]['tid'];
      $city = taxonomy_term_load($city_id);
      return $city->name;
    }
  }
  if ($entity[0] == 'search') {
    $city = taxonomy_term_load($_GET['city']);
    return $city->name;
  }
}

/**
 * Form builder for filter form complex apartments.
 */
function realty_filter_complex_apartment_form($form, $form_state) {

  $node_id = arg('1');
  $node = node_load($node_id);
  if ($node->type == 'apartament') {
    $home = taxonomy_term_load($node->field_apartament_home['und'][0]['tid']);
    $complex_id = $home->field_home_complex['und'][0]['target_id'];
  }
  else {
    $complex_id = $node->nid;
  }
  $complex = node_load($complex_id);
  $homes = views_get_view_result('term_view', 'homes_complex', $complex_id);
  foreach ($homes as $key=>$home) {
    $options[$home->tid] = $home->field_field_address_house[0]['rendered']['#markup'];
    $sections[$home->field_field_address_house[0]['rendered']['#markup']]
      [$home->field_field_number_section[0]['rendered']['#markup'].':'.$home->tid] =
      $home->field_field_number_section[0]['rendered']['#markup'];
  }

  $form['address'] = array(
    '#type' => 'select',
    '#options' => $options,
    '#multiple' => TRUE,
    '#size' => 5,
    '#attributes' => array(
      'class' => array('cf'),
      'id' => 'filter-form-address',
    ),
  );

  $form['sections'] = array(
    '#type' => 'select',
    '#options' => $sections,
    '#multiple' => TRUE,
    '#size' => 5,
    '#attributes' => array(
      'class' => array('cf'),
      'id' => 'filter-form-section',
    ),
  );

  return $form;

}


/**
 * Implement hook_form_alter.
 */
function realty_form_views_exposed_form_alter(&$form, &$form_state) {
  if ($form['#id'] == 'views-exposed-form-apartments-apartment-complex') {
    $form['#theme'] = 'realty_views_exposed_form';
  }
}
