<?php
/**
 * @file
 */

define('REALTY_FRONT_THEME_PATH', drupal_get_path('theme', 'realty_theme'));

/*
 * implement hook_init.
 */
function realty_init() {
  $object = menu_get_object('taxonomy_term', 2);

  if (current_path() == '<front>') {
    if (!drupal_is_cli()) {
      drupal_goto('taxonomy/term/1');
    }
  }

  if (!empty($object) && $object->vid == 1) {
    drupal_add_js(array('id' => 'index'), 'setting');
  }
}

/**
 * get the path to the directory /files
 */

function realty_file_directory_path() {
  return variable_get('file_directory_path', conf_path() .'/files');
}

/*
 * implement hook_menu.
 */
function realty_menu(){

  $item['get_developer_complex'] = array(
    'title' => 'complex',
    'page callback' => 'realty_get_developer_complex',
    'access callback' => TRUE,
  );

  $item['get_id_apartment'] = array(
    'page callback' => 'realty_get_id_apartment',
    'access callback' => TRUE,
  );

  $item['apartment_comparison'] = array(
    'page callback' => 'realty_apartment_comparison',
    'access callback' => TRUE,
  );

  $item['search_map'] = array(
    'page callback' => 'realty_search_map',
    'access callback' => TRUE,
  );

  $item['get_data_complex'] = array(
    'page callback' => 'realty_get_data_complex',
    'access callback' => TRUE,
  );

  return $item;
}

/**
 * Implements hook_menu().
 */

function realty_theme() {

  $base = array(
    'file' => 'theme.inc',
    'path' => drupal_get_path('module', 'realty') . '/theme',
  );

  $items['search_form'] = array(
    'template' => 'search-form',
    'render element' => 'form',
  );

  $items['realty_user_menu'] = array(
    'template' => 'realty-user-menu',
    'variables' => array(
      'account' => NULL,
    ),
  );

  $items['realty_user_profile_form'] = $base + array(
    'template' => 'realty-user-profile-form',
    'render element' => 'form',
  );

  $items['id_apartment_pdf'] = array(
    'file' => 'theme.inc',
    'path' => drupal_get_path('module', 'realty') . '/theme',
    'variables' => array(
    ),
    'template' => 'realty-id-apartment-pdf',
  );


  $items['realty_map_complex'] = array(
    'variables' => array(
      'nid' => NULL,
    ),
    'template' => 'realty-map-complex',
  );

  return $items;
}

/**
 * Page callback to /get_data_complex.
 */
function realty_get_data_complex() {

  if ($_POST['nid']) {
    $node = node_load($_POST['nid']);

    $answer['title'] = $node->title;

    $answer['image'] = theme('image', array(
      'path' => $node->field_main_photo['und'][0]['uri'],
      'attributes' => array(
        'class' => array('title-image'),
      ),
    ));

    if (!empty($node->field_complex_logo)) {
      $answer['logo'] = theme('image', array(
        'path' => $node->field_complex_logo['und'][0]['uri'],
        'attributes' => array(
          'class' => array('logo-z', 'vertical-logo'),
        ),
      ));
    }

    if(!empty($node->field_description)) {
      $answer['description'] = $node->field_description['und'][0]['value'];
    }

    $answer['details'] = l('details', 'node/' . $node->nid, array('attributes' => array('class' => array(
      'button-info','button-info-top')
    )));

    print json_encode($answer);
  }

  drupal_exit();
}

/**
 * List all cities.
 */
function realty_get_list_city(){
  $vid = taxonomy_vocabulary_machine_name_load('cities');
  return $terms = taxonomy_get_tree($vid->vid, 0, NULL, TRUE);
}

/**
 * Page callback to /search_map.
 */
function realty_search_map() {

  $block = new stdClass();

  $area = $_POST['area'];

  $view = views_get_view('map');
  $view->set_display('main_map');

  $view->display_handler->options['filters']['field_category_tid']['value'] = 36;
  $view->pre_execute(array());
  $block->content = $view->display_handler->preview();
  $view->post_execute();
  print $block->content;
 }


/**
 * Implement hook form_alter.
 */
function realty_form_user_profile_form_alter(&$form, &$form_id) {
  global $user;

  if($user->uid != 1) {
    $form['#theme'][0] = 'realty_user_profile_form';
  }
}

/**
 * Implement hook form_alter.
 */
/*function realty_form_user_profile_form_alter(&$form, &$form_id) {
  global $user;

  if($user->uid != 1) {
    $form['#theme'][0] = 'realty_user_profile_form';
  }
}

/**
 * Page callback to /get_id_apartment.
 */
function realty_get_id_apartment(){
  global $user;

  $account = user_load($user->uid);
  $node = node_load($_POST['nid']);
  $flag = FALSE;
  if (isset($account->field_received_id)) {
    if (!isset($account->field_received_id[LANGUAGE_NONE])) {
      $account->field_received_id = array(
        LANGUAGE_NONE => array(),
      );
    }
    foreach ($account->field_received_id[LANGUAGE_NONE] as $val) {
      if ($val['target_id'] == $node->nid) {
        $flag = TRUE;
        break;
      }
    }

    if ($flag == FALSE) {
      array_push($account->field_received_id[LANGUAGE_NONE], array('target_id' => $node->nid));
      user_save($account);
    }
    realty_generation_pdf_apartment($node);
    drupal_exit();
  }
}

/**
 * Page callback to /get_id_apartment.
 */
function realty_apartment_comparison() {
  global $user;

  $account = user_load($user->uid);
  if ($user->uid != 0 ) {
    $node = node_load($_POST['nid']);
    $flag = FALSE;
    if (isset($account->field_apartment_comparison)) {
      if (!isset($account->field_apartment_comparison[LANGUAGE_NONE])) {
        $account->field_apartment_comparison = array(
          LANGUAGE_NONE => array(),
        );
      }
      foreach ($account->field_apartment_comparison[LANGUAGE_NONE] as $val) {
        if ($val['target_id'] == $node->nid) {
          $flag = TRUE;
          break;
        }
      }

      if ($flag == FALSE) {
        array_push($account->field_apartment_comparison[LANGUAGE_NONE], array('target_id' => $node->nid));
        user_save($account);
      }
      realty_generation_pdf_apartment($node);
      drupal_exit();
    }
  }
}

/*
 *Page callback to /get_developer_complex.
 */
function realty_get_developer_complex() {

  foreach($_POST['developer'] as $value) {
    $developer_id[] = $value;
  }
  $complexes = realty_get_complex_current_city($developer_id, $_POST['city']);
  if (!empty($complexes)) {
    $options = '';
    foreach($complexes as $key => $complex) {
      $options['modal'] .= '<div class="col-xs-4">
        <li>
          <label class="checkbox-inline check-style">
            <input type="checkbox" class="inlineCheckbox1 CheckboxComplex " value="'.$key.'"> '.$complex.'
          </label>
        </li>
      </div>';
      $options['select'] .= '<option value='.$key.'>'.$complex.'</option>';
    }
  }
  print json_encode($options);
  drupal_exit();
}

/**
 * Get options the current city
 */
function realty_get_options_current_city($option) {

  $city = menu_get_object('taxonomy_term', 2);
  $city != null ? $city_tid = $city->tid : $city_tid = $_GET['city'];
  $view = views_get_view('search');
  if ($option == 'area') {
    $view->set_display('search_area');
    $view->display_handler->options['filters']['field_area_city_tid']['value'] = $city_tid;
  }
  if ($option == 'metro') {
    $view->set_display('search_metro');
    $view->display_handler->options['filters']['field_city_metro_tid']['value'] = $city_tid;
  }
  $view->pre_execute(array());
  $view->display_handler->preview();
  $view->post_execute();

  foreach($view->result as $value) {
    $options[$value->tid] = $value->taxonomy_term_data_name;
  }

  isset($options) ?  : $options = null;

  return $options;
}


/**
 * Get developers the current city
 */
function realty_get_developer_current_city(){
  $city = menu_get_object('taxonomy_term', 2);
  $city != null ? $city_tid = $city->tid : $city_tid = $_GET['city'];
  $view = views_get_view('term_view');
  $view->set_display('developers_search');
  $view->display_handler->options['arguments']['tid']['default_argument_options']['argument'] = $city_tid;
  $view->pre_execute(array());
  $view->display_handler->preview();
  $view->post_execute();
  foreach($view->result as $value) {
    $developer_option[$value->tid] = $value->_field_data['tid']['entity']->name;
  }

  isset($developer_option) ?  : $developer_option = null;

  return $developer_option;
}

/**
 * Get complex the current city
 */
function realty_get_complex_current_city($developers = null, $city_tid = null){
  $city = menu_get_object("taxonomy_term", 2);
  if(isset($_GET['city']) || $city) {
    $city != null ? $city_tid = $city->tid : $city_tid = $_GET['city'];
  }
  $view = views_get_view('complex');
  if($developers != null && $city == null) {
    $view->set_display('complex_developer');
    unset($view->display_handler->options['filters']['field_complex_developer_tid']['value']);
    foreach($developers as $value) {
      $view->display_handler->options['filters']['field_complex_developer_tid']['value'][$value] = $value;
    }
  }
  else {
    $view->set_display('complexs_search');
    $view->display_handler->options['arguments']['tid']['default_argument_options']['argument'] = $city_tid;
  }
  $view->pre_execute(array());
  $view->display_handler->preview();
  $view->post_execute();
  $complex_option = array();
  foreach($view->result as $value) {
    $complex_option[$value->nid] = $value->node_title;
  }

  isset($complex_option) ?  : $complex_option = null;

  return $complex_option;
}

/**
 * Generate pdf file id apartments.
 */
function realty_generation_pdf_apartment($node) {
  $html = theme('id_apartment_pdf', array());
  $error = FALSE;

  if (($library = libraries_load('phpwkhtmltopdf')) && !empty($library['loaded'])) {
    $pdf = new WkHtmlToPdf;
    $file_path = file_directory_temp() . '/' . time() . '.html';
    if (file_put_contents($file_path, $html)) {
      $pdf->addPage($file_path);
      $pdf_path = "/var/www/realty/sites/default/files/pdf/id_apartment-$node->nid.pdf";
      $pdf_file = "/sites/default/files/pdf/id_apartment-$node->nid.pdf";
      if (!$pdf->saveAS($pdf_path)) {
        $error = TRUE;
      }
      unlink($file_path);
    }
    else {
      $error = TRUE;
    }
  }
  else {
    $error = TRUE;
  }

  if ($error) {
    print $html;
  }

  print $pdf_file;

  drupal_exit();
}

/**
 * Form builder for search map form.
 */
function realty_search_map_form($form, $form_state) {

  $area_option = realty_get_options_current_city('area');
  $category_option = realty_options_search('category');

  $form['area'] = array(
    '#type'=>'select',
    '#title'=>'Area',
    '#name'=>'area[]',
    '#options'=> $area_option,
    '#attributes' => array(
      'id' => 'area-map',
      'multiple' => 'multiple',
    ),
  );

  $form['category'] = array(
    '#type'=>'select',
    '#title'=>'Category',
    '#name'=>'category[]',
    '#options'=> $category_option,
    '#attributes' => array(
      'id' => 'map-filter',
      'multiple' => 'multiple',
      'class' => 'maps',
    ),
  );

  $form['stock'] = array(
    '#type'=>'checkbox',
    '#title'=>'Stock',
    '#attributes' => array(
      'id' => 'stock-map',
    ),
  );

  return $form;
}

/**
 * Options to search for apartments.
 */

function realty_options_search($option) {

  switch ($option) {
    case 'room' :
      return array(
      '1'=>'1 комната',
      '2'=>'2 комнаты',
      '3'=>'3 комнаты',
      '4'=>'4 комнаты',
      );

    case 'quarter' :
      return array(
      '1' => '1 квартал',
      '2' => '2 квартал',
      '3' =>'3 квартал',
      '4' =>'4 квартал',
      );

    case 'masonry' :
      return array(
      '1' => 'Кирпич',
      '2' => 'Монолит',
      );

    case 'category' :
      return array(
      '1' => 'Эконом',
      '2' => 'Комфорт',
      '3' => 'Бизнес',
      );
    case 'balcony' :
      return array(
        '1' => 'Балкон',
        '2' => 'Лоджия',
        '3' => 'Балкон+лоджия',
      );
  }
}

/**
 * Form builder for search form.
 */
function realty_search_form($form, $form_state) {

  $area_option = realty_get_options_current_city('area');
  $metro_option = realty_get_options_current_city('metro');
  $developer_option = realty_get_developer_current_city();
  $complex_option = realty_get_complex_current_city();
  $room_option = realty_options_search('room');
  $quarter_option = realty_options_search('quarter');
  $masonry_option = realty_options_search('masonry');
  $balcony_option = realty_options_search('balcony');
  $category_option = realty_options_search('category');
  $city = menu_get_object('taxonomy_term', 2);

  $form['city'] = array(
    '#type' => 'hidden',
    '#title' => 'city',
    '#value' => isset($_GET['city']) ? $_GET['city'] : $city->tid,
  );

  $form['area'] = array(
    '#type'=>'select',
    '#title'=>'Area',
    '#name'=>'area[]',
    '#options'=> $area_option,
    '#default_value' => isset($_GET['area']) ? $_GET['area'] : 0,
    '#attributes' => array(
      'id' => 'area',
      'multiple' => 'multiple',
    ),
  );

  $form['metro'] = array(
    '#type'=>'select',
    '#title'=>'metro',
    '#name'=>'metro[]',
    '#options'=> $metro_option,
    '#default_value' => isset($_GET['metro']) ? $_GET['metro'] : 0,
    '#attributes' => array(
      'id' => 'metro',
      'multiple' => 'multiple',
    ),
  );

  $form['masonry'] = array(
    '#type'=>'select',
    '#title'=>'Masonry',
    '#name'=>'masonry[]',
    '#options'=> $masonry_option,
    '#default_value' => isset($_GET['masonry']) ? $_GET['masonry'] : 0,
    '#attributes' => array(
      'id' => 'wall_type',
      'multiple' => 'multiple',
      'class' => array('ss'),
    ),
  );


  $form['balcony'] = array(
    '#type'=>'select',
    '#title'=>'balcony',
    '#name'=>'balcony[]',
    '#options'=> $balcony_option,
    '#default_value' => isset($_GET['balcony']) ? $_GET['balcony'] : false,
    '#attributes' => array(
      'id' => 'balkon',
      'multiple' => 'multiple',
      'class' => array('ss'),
    ),
  );

  $form['category'] = array(
    '#type'=>'select',
    '#title'=>'Category',
    '#name'=>'category[]',
    '#options'=> $category_option,
    '#default_value' => isset($_GET['category']) ? $_GET['category'] : 0,
    '#attributes' => array(
      'id' => 'cat',
      'multiple' => 'multiple',
      'class' => array('ss mini-ss'),
    ),
  );

  $form['floor'] = array(
    '#type'=>'textfield',
    '#title'=>'floor',
    '#default_value' => isset($_GET['floor']) ? $_GET['floor'] : false,
    '#attributes'=>array(
      'id' => 'floor',
      'maxlength' => 2,
      'class' => array('search-input',
        'mini-width',
        'floor',
      ),
    ),
  );

  $form['room'] = array(
    '#type'=>'select',
    '#title'=>'Number of room',
    '#name'=>'room[]',
    '#options'=> $room_option,
    '#default_value' => isset($_GET['room']) ? $_GET['room'] : 0,
    '#attributes'=>array(
      'id' => 'room',
      'multiple' => 'multiple',
    ),
  );

  $form['sq'] = array(
    '#type'=>'hidden',
    '#title'=>'Sq from',
    '#default_value' => isset($_GET['sq']) ? $_GET['sq'] : '30;150',
    '#attributes'=>array(
      'class' => array('ion-slider', 'sq'),
    ),
  );

  $form['price'] = array(
    '#type'=>'hidden',
    '#title'=>'Price from',
    '#default_value' => isset($_GET['price']) ? $_GET['price'] : '55;85',
    '#attributes'=>array(
      'class' => array('ion-slider', 'price'),
    ),
  );

  $form['parking'] = array(
    '#type'=>'checkbox',
    '#title'=>'Parking',
    '#default_value' => isset($_GET['parking']) && $_GET['parking'] == 1  ? 1 : 0,
    '#attributes'=>array(
      'id ' => 'parking',
    ),
  );

  $form['coast'] = array(
    '#type'=>'hidden',
    '#title'=>'Coast',
    '#default_value' => isset($_GET['coast']) ? $_GET['coast'] : '1.6;4',
    '#attributes'=>array(
      'class' => array('ion-slider', 'coast'),
    ),
  );

  $form['developer'] = array(
    '#type'=>'select',
    '#title'=>'Developer',
    '#name'=>'developer[]',
    '#options'=> $developer_option,
    '#default_value' =>isset($_GET['developer']) ? $_GET['developer'] : 0,
    '#attributes' => array(
      'id' => 'developer',
      'multiple' => 'multiple',
    ),
  );

  $form['complex'] = array(
    '#type'=>'select',
    '#title'=>'Complex',
    '#name'=>'complex[]',
    '#options'=> $complex_option,
    '#default_value' =>isset($_GET['complex']) ? $_GET['complex'] : 0,
    '#attributes' => array(
      'id' => 'complex',
      'multiple' => 'multiple',
    ),
  );

  $form['quarter'] = array(
    '#type'=>'select',
    '#title'=>'Quarter',
    '#name'=>'quarter[]',
    '#options'=> $quarter_option,
    '#default_value' =>isset($_GET['quarter']) ? $_GET['quarter'] : 0,
    '#attributes' => array(
      'id' => 'date',
      'multiple' => 'multiple',
      'class' => array('ss mini-ss'),
    ),
  );

  $form['year'] = array(
    '#type'=>'textfield',
    '#title'=>'Year',
    '#default_value' =>isset($_GET['year']) ? $_GET['year'] : null,
    '#attributes'=>array(
      'class' => array('search-input ear'),
      'placeholder' => t('Year'),
      'maxlength' => '4',
    ),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Choose option'),
    '#attributes' => array(
      'class' => array('search-button'),
    ),
  );

  $form['#method'][] = 'GET';
  $form['#action'] = '/search';
  $form['#theme'][] = 'search_form';

  return $form;
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function realty_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'panels') {
    return "plugins/$plugin_type";
  }

  if ($owner == 'ctools' && $plugin_type == 'content_types') {
    return "plugins/content_types";
  }
}

/**
 * Draw user menu.
 */
function realty_user_menu($account) {

  return theme('realty_user_menu', array('account' => $account));
}

/**
 * Get the current city.
 */
function realty_get_current_city() {

  if (!isset($_GET['q'])) {
    return null;
  }

  $entity = explode('/' ,$_GET['q']);

  if ($entity[0] == 'taxonomy') {
    $term = taxonomy_term_load($entity[2]);
    if ($term->vocabulary_machine_name == 'cities') {
      return $term->name;
    }
    if ($term->vocabulary_machine_name == 'developers' ) {
      $city_id = $term->field_city[LANGUAGE_NONE][0]['tid'];
      $city = taxonomy_term_load($city_id);
      return $city->name;
    }
  }
  if ($entity[0] == 'node') {
    $node = node_load($entity[1]);
    if ($node->type == 'complex') {
      $dev_id = $node->field_complex_developer[LANGUAGE_NONE][0]['tid'];
      $term = taxonomy_term_load($dev_id);
      $city_id = $term->field_city[LANGUAGE_NONE][0]['tid'];
      $city = taxonomy_term_load($city_id);
      return $city->name;
    }
    if ($node->type == 'apartament') {
      $home_id = $node->field_apartament_home[LANGUAGE_NONE][0]['tid'];
      $home = taxonomy_term_load($home_id);
      $complex_id = $home->field_home_complex[LANGUAGE_NONE][0]['target_id'];
      $complex = node_load($complex_id);
      $dev_id = $complex->field_complex_developer[LANGUAGE_NONE][0]['tid'];
      $term = taxonomy_term_load($dev_id);
      $city_id = $term->field_city[LANGUAGE_NONE][0]['tid'];
      $city = taxonomy_term_load($city_id);
      return $city->name;
    }
  }
  if ($entity[0] == 'search') {
    $city = taxonomy_term_load($_GET['city']);
    return $city->name;
  }
}